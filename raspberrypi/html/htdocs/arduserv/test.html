<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<script language="javascript" type="text/javascript" src="paper-full.js"></script>
	<script language="javascript" type="text/paperscript" canvas="canvas" keepalive="true">
		var k=0;
		update_graphics=function(){
			var children=project.activeLayer.children;
			for (var i=0;i<children.length;i++) {
				children[i].position.x-=5;
				if(children[i].position.x<=0){
					children[i].remove()
				}
			}
			k++;
			var sonar_data=new Path.Rectangle(new Point(500, (150+Math.sin(k/10)*100)), 5,5);
			sonar_data.fillColor='#FF0000';

			var sonar_data2=new Path.Rectangle(new Point(500, (150+Math.sin(k/5)*100)), 5,5);
			sonar_data2.fillColor='#00FF00';

			var sonar_data3=new Path.Rectangle(new Point(500, (150+Math.sin(k/15)*100)), 5,5);
			sonar_data3.fillColor='#0000FF';

			var sonar_data4=new Path.Rectangle(new Point(500, (150+Math.sin(k/35)*100)), 5,5);
			sonar_data4.fillColor='#AFAFAF';
			
			view.draw();
		}
	</script>
	<script language="javascript" type="text/javascript" >
		var xhr = new XMLHttpRequest();
		var xhr_read_point=0;
		var nmea_start_point=0;
		var date = new Date;
		var fps=0;
		var bps=0;

		open_hendler();
		function open_hendler(){
			xhr.open('GET', '/cgi-bin/stream_usart.sh', true);
			xhr.overrideMimeType('text/plain; charset=x-user-defined');

			xhr.onprogress=function(e){
				parse_data();
			};
			xhr.send();
		}
		function parse_data(){
			status_div.innerHTML='Buffer size:'+(xhr.responseText.length-xhr_read_point);
			status_div.innerHTML+='<br>Buffer counter:'+xhr.responseText.length;
			
			var date_old=date;
			date = new Date;
			fps=fps*0.95+(1/((date-date_old)/1000))*0.05;
			status_div.innerHTML+='<br>FPS:'+(fps.toFixed(2));
			
			bps=bps*0.95+8*((xhr.responseText.length-xhr_read_point)/((date-date_old)/1000))*0.05;
			status_div.innerHTML+='<br>BPS:'+(bps.toFixed(2));
			
			for(var i=xhr_read_point;i<xhr.responseText.length;i++){
				//center_div.innerHTML+=xhr.responseText.charCodeAt(i)+'<br>';
				//var c=xhr.responseText.charAt(i);
				//.charCodeAt(i);
				if(xhr.responseText.charAt(i)=='$'){
					nmea_start_point=i;
					//center_div.innerHTML='found_$:'+i+'';
				}
				if(xhr.responseText.charCodeAt(i)==10){
					center_div.innerHTML='';
					for(var j=nmea_start_point;j<i;j++){
						center_div.innerHTML+=xhr.responseText.charAt(j);	
					}
					//update_graphics();//!!!
				}
			}
			xhr_read_point=xhr.responseText.length;
		}
	</script>
</head>
<body>
	<div id="status_div"></div>
	<div id="center_div"></div>
	<canvas id="canvas" width="505" height="300" style="background: #000000;"></canvas>
</body>
</html>


