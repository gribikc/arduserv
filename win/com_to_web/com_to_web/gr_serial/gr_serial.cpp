#include "gr_serial.h"

////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
void gr_serial::serial_open(int num, int speed){
    QString name="COM"+QString::number(num);
    qDebug() << name;

    serial=new QSerialPort();//this
    serial->setPortName(name);//78

    serial->open(QIODevice::ReadWrite);
    if(serial->isOpen()){
        qDebug() << "COMport OPEN\n";
        serial->setBaudRate(speed);//115200
        serial->setDataBits(QSerialPort::Data8);
        //serial->setDirection(QSerialPort::AllDirections);//!!!
        serial->setParity(QSerialPort::NoParity);
        serial->setStopBits(QSerialPort::OneStop);
        serial->setFlowControl(QSerialPort::NoFlowControl);
    }else{
       qDebug() << "COMport NOT OPENed\n";
    }

    serial->flush();
    serial->write("D");
    serial->readAll();
    connect(serial, &QSerialPort::readyRead, this, &gr_serial::serial_read);
}
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
void gr_serial::no_more_client(){
    serial->close();//!!!
    serial->deleteLater();// deleteLater()
    this->deleteLater();
    qDebug() << "COM Close;";
}
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
void gr_serial::serial_read(){
    QByteArray in_data=serial->readAll();
    send_data_to_client(&in_data);
}
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
void gr_serial::write_data(QByteArray *data){
    serial->write(*data);
}
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
